networks:
  qairon:
    driver: bridge

configs:
  tempo-config:
    content: |
      server:
        http_listen_port: 3200
        grpc_listen_port: 9095
      distributor:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: 0.0.0.0:4317
              http:
                endpoint: 0.0.0.0:4318
      ingester:
        max_block_duration: 5m
        lifecycler:
          ring:
            kvstore:
              store: inmemory
            replication_factor: 1
      storage:
        trace:
          backend: local
          wal:
            path: /var/tempo/wal
            ingestion_time_range_slack: 8760h
          local:
            path: /var/tempo/blocks
      query_frontend:
        search:
          max_duration: 8760h
      overrides:
        max_traces_per_user: 5000000
        ingestion_rate_limit_bytes: 500000000
        ingestion_burst_size_bytes: 1000000000

services:
  victoria:
    image: victoriametrics/victoria-metrics:v1.134.0
    container_name: victoria
    networks:
      - qairon
    ports:
      - "8428:8428"
    volumes:
      - /mnt/qairon/victoria-metrics-data:/victoria-metrics-data:z
    command:
      - -retentionPeriod=2y
      # Read performance: cache historical data for 1 year
      - -search.cacheTimestampOffset=8760h
      - -search.maxQueryDuration=60s
      # Read performance: parallel query handling for dashboard bursts
      - -search.maxConcurrentRequests=32
      - -search.maxQueueDuration=30s
      # Read performance: fresher reads (default 30s delays results)
      - -search.latencyOffset=5s
      # Read performance: longer cache retention and more RAM for caches
      - -cacheExpireDuration=1h
      - -memory.allowedPercent=80
    deploy:
      resources:
        limits:
          cpus: "32"
          memory: 75g
    restart: unless-stopped

  victorialogs:
    image: victoriametrics/victoria-logs:v1.43.1
    container_name: victorialogs
    networks:
      - qairon
    ports:
      - "9428:9428"
    volumes:
      - /mnt/qairon/victoria-logs-data:/victoria-logs-data:z
    command:
      - -retentionPeriod=2y
      # Ingest performance
      - -maxConcurrentInserts=240
      - -fs.maxConcurrency=1000
      - -inmemoryDataFlushInterval=15s
      # Read performance: parallel query handling for dashboard log panels
      - -search.maxConcurrentRequests=32
      - -search.maxQueryDuration=120s
      # Read performance: more RAM for caches
      - -memory.allowedPercent=80
    deploy:
      resources:
        limits:
          cpus: "32"
          memory: 75g
    restart: unless-stopped

  tempo:
    image: grafana/tempo:2.10.0
    container_name: tempo
    networks:
      - qairon
    ports:
      - "3200:3200"
      - "4317:4317"
      - "4318:4318"
    configs:
      - source: tempo-config
        target: /tempo.yaml
    volumes:
      - /mnt/qairon/tempo-data:/var/tempo:z
    command:
      - --config.file=/tempo.yaml
    deploy:
      resources:
        limits:
          memory: 75g
    restart: unless-stopped

  grafana:
    image: grafana/grafana:12.3.1
    container_name: grafana
    networks:
      - qairon
    ports:
      - "3000:3000"
    volumes:
      - /mnt/qairon/grafana:/var/lib/grafana:z
    environment:
      - GF_INSTALL_PLUGINS=victoriametrics-logs-datasource,yesoreyeram-infinity-datasource
    restart: unless-stopped